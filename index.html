<!doctype html>
<meta charset="utf8">
<link rel="stylesheet" href="assets/dist/style.css">

<body>

<header>
  <h1>Explorează Bucureștiul</h1>
  <h2>...atunci și acum:</h2>
</header>

<div id="map"></div>

<div id="detail">
  <h3>Lipscani, colț cu Băcani</h3>
  <div id="photo"></div>
</div>

<script src="https://d3js.org/d3.v5.min.js"></script>

<script>
(function() {

const ASSETS = "assets";
const PLACES_KML = `${ASSETS}/Muzeul Comunismului Devel.kml`;
const CITY_GEOJSON = `${ASSETS}/bucuresti.geojson`;
const CITY_NAME = "București";

function renderMap(parent, city, places, onClickPlace) {
  const width = parent.clientWidth;
  const height = parent.clientHeight;
  const centroid = d3.geoPath().centroid(city);
  const bounds = d3.geoPath().bounds(city);
  const boundsWidth = (bounds[1][0] - bounds[0][0]) / 360 * 2 * Math.PI * 1.2;
  const cityScale = (width - 1) / boundsWidth;

  const projection = d3.geoMercator()
    .center(centroid);

  const render = d3.geoPath(projection);

  const zoom = d3.zoom()
    .scaleExtent([1, 8])
    .on("zoom", () => { zoomed(d3.event.transform) });

  const svg = d3.select(parent).append("svg")
    .attr("width", width)
    .attr("height", height);

  const g = svg.append("g");

  svg.call(zoom);

  const cityPath = g.append("path")
    .datum(city)
    .attr("class", "city");

  const locations = g.append("g")
    .selectAll(".location")
    .data(places)
    .enter().append("path")
      .attr("class", "location")
      .on("click", onClickPlace);

  function zoomed(transform) {
    const {x, y, k} = transform;

    projection
      .translate([k * width / 2 + x, k * height / 2 + y])
      .scale(cityScale * k);

    cityPath.attr("d", render);
    locations.attr("d", render);
  }

  zoomed({x: 0, y: 0, k: 1});
}

async function getPlaces(name) {
  const shim = await d3.xml(PLACES_KML);
  const href = shim.querySelector("NetworkLink > Link > href").textContent;
  const kml = await d3.xml(href);

  for (let folder of kml.querySelectorAll("Folder")) {
    if (folder.querySelector("name").textContent === name) {
      const features = [];

      for (let placemark of folder.querySelectorAll("Placemark")) {
        const description = placemark.querySelector("description").textContent;
        const temp = (new DOMParser).parseFromString(description, "text/html").querySelector("body");
        for (let image of temp.querySelectorAll("img")) {
          image.remove();
        }
        const filename = temp.textContent;

        const coords = placemark.querySelector("Point > coordinates").textContent.trim().split(",");
        const [lng, lat] = [+coords[0], +coords[1]];

        const feature = {
          type: "Feature",
          geometry: {
            type: "Point",
            coordinates: [lng, lat],
          },
          properties: { filename },
        };
        features.push(feature);
      }

      return features;
    }
  }
}

function placeClicked(feature) {
  document.querySelector("#photo").innerText = feature.properties.filename;
}

(async function() {
  const parent = document.querySelector("#map");
  const city = await d3.json(CITY_GEOJSON);
  const places = await getPlaces(CITY_NAME);

  renderMap(parent, city, places, placeClicked);
})();

})();
</script>
