<!doctype html>
<meta charset="utf8">
<link rel="stylesheet" href="dist/style.css">

<body>

<header>
  <h1>Explorează Bucureștiul</h1>
  <h2>...atunci și acum:</h2>
</header>

<div id="map"></div>

<div id="detail">
  <h3>Lipscani, colț cu Băcani</h3>
  <div id="photo"></div>
</div>

<script src="https://d3js.org/d3.v5.min.js"></script>

<script>
(function() {

function renderMap(parent, city) {
  const width = parent.clientWidth;
  const height = parent.clientHeight;

  const projection = d3.geoMercator();

  const path = d3.geoPath()
    .projection(projection);

  const zoom = d3.zoom()
    .scaleExtent([1, 8])
    .on("zoom", zoomed);

  const svg = d3.select(parent).append("svg")
    .attr("width", width)
    .attr("height", height);

  const g = svg.append("g");

  svg.call(zoom);

  function zoomed() {
    g
      .selectAll("path") // To prevent stroke width from scaling
      .attr("transform", d3.event.transform);
  }

  const centroid = d3.geoPath().centroid(city);
  const bounds = d3.geoPath().bounds(city);
  const boundsWidth = (bounds[1][0] - bounds[0][0]) / 360 * 2 * Math.PI * 1.2;
  projection
    .translate([width / 2, height / 2])
    .center(centroid)
    .scale((width - 1) / boundsWidth);
  g.append("path")
    .datum(city)
    .attr("class", "city")
    .attr("d", path);
}

async function getPlaces(name) {
  const shim = await d3.xml("geo/Muzeul Comunismului Devel.kml");
  const href = shim.querySelector("NetworkLink > Link > href").textContent;
  const kml = await d3.xml(href);
  for (let folder of kml.querySelectorAll("Folder")) {
    if (folder.querySelector("name").textContent === name) {
      const places = [];
      for (let placemark of folder.querySelectorAll("Placemark")) {
        const description = placemark.querySelector("description").textContent;
        const temp = (new DOMParser).parseFromString(description, "text/html").querySelector("body");
        for (let image of temp.querySelectorAll("img")) {
          image.remove();
        }
        const filename = temp.textContent;
        const coords = placemark.querySelector("Point > coordinates").textContent.trim().split(",");
        const [lng, lat] = [+coords[0], +coords[1]];
        const location = {
          filename,
          coords: { lng, lat },
        };
        places.push(location);
      }
      return places;
    }
  }
}

(async function() {
  const parent = document.querySelector("#map");
  const city = await d3.json("bucuresti.geojson");
  const places = await getPlaces("București");

  renderMap(parent, city);
  console.log(places);
})();

})();
</script>
